{
  "load": "SELECT key, original_url, rand() as rand FROM `wikimedia.image_vectors` ORDER BY rand LIMIT 70",
  "similar": "CREATE TEMPORARY FUNCTION distance(v1 ARRAY<FLOAT64>,\n    v2 ARRAY<FLOAT64>)\n  RETURNS FLOAT64\n  LANGUAGE js AS \"\"\"\n              var dist = 0.0\n              for (var i=0; i < v1.length; i++) {\n                dist += (v1[i] - v2[i])**2\n              }\n              return Math.sqrt(dist);\n            \"\"\";\nSELECT\n  a.key,\n  distance(a.vector,\n    b.vector) AS dist,\n  original_url\nFROM (\n  SELECT\n    key,\n    vector,\n    original_url\n  FROM\n    `wikimedia.image_vectors`) AS a\nCROSS JOIN (\n  SELECT\n    vector\n  FROM\n    `wikimedia.image_vectors_1`\n  WHERE\n    key = \"<%= id %>\") AS b\nORDER BY\n  dist ASC\nLIMIT\n  50",
  "hackerNews": "  CREATE TEMPORARY FUNCTION prod(v1 ARRAY<FLOAT64>,\n    v2 ARRAY<FLOAT64>)\n  RETURNS FLOAT64\n  LANGUAGE js AS \"\"\"\n              var d = 0.0\n              for (var i=0; i < v1.length; i++) {\n                d += (v1[i] * v2[i])\n              }\n              return d;\n            \"\"\";\nSELECT\n  id,\n  prod(a.vector,\n    b.vector) AS similarity,\n  title,\n  text\nFROM (\n  SELECT\n    id,\n    title,\n    text,\n    vector\n  FROM\n    `queryit-smart.hackernews.stories_with_vector`) AS a\nCROSS JOIN (\n  SELECT\n    vector\n  FROM\n    `queryit-smart.hackernews.stories_with_vector`\n  WHERE\n    id = <%= id %>\n  LIMIT\n    1) AS b\nORDER BY\n  similarity DESC\nLIMIT\n  10",
  "stackOverflow": "CREATE TEMPORARY FUNCTION\n  calc_similarity(tf_idf_json_0 STRING,\n    tf_idf_json_1 STRING)\n  RETURNS FLOAT64\n  LANGUAGE js AS \"\"\"\n// parse JSON to extract tf_idf\nvar tf_idf_0 = JSON.parse(tf_idf_json_0);\nvar tf_idf_1 = JSON.parse(tf_idf_json_1);\n// calculate cosine similarity\nvar similarity = 0;\nvar total = 0;\nfor (word in tf_idf_0) {\n  var t0 = tf_idf_0[word] ? Number(tf_idf_0[word]) : 0;\n  var t1 = tf_idf_1[word] ? Number(tf_idf_1[word]) : 0;\n  similarity += (t0 < t1 ? t0 : t1);\n  total += t0;\n}\nreturn similarity/total;\n\"\"\";\nSELECT\n  id,\n  title,\n  body,\n  tags,\n  similarity\nFROM (\n  SELECT\n    t1.id,\n    calc_similarity(tf_idf_0,\n      t1.tf_idf) AS similarity\n  FROM (\n    SELECT\n      tf_idf AS tf_idf_0\n    FROM\n      `queryit-smart.stackoverflow.top10M_posts_tf_idf` AS t0\n    WHERE\n      id = <%= id %> )\n  CROSS JOIN\n    `queryit-smart.stackoverflow.top10M_posts_tf_idf` AS t1)\nJOIN\n  `queryit-smart.stackoverflow.top100K_view_count_posts` AS t2\nUSING\n  (id)\nORDER BY\n  similarity DESC\nLIMIT\n  10",
  "citibike": "CREATE TEMPORARY FUNCTION usage(month INT64,\n    wday INT64,\n    hour INT64,\n    station_id INT64,\n    latitude FLOAT64,\n    longitude FLOAT64,\n    temp FLOAT64,\n    weather STRING)\n  RETURNS FLOAT64\n  LANGUAGE js AS \"\"\"\n              weather = [\"sunny\", \"rain\", \"snow\"].indexOf(weather);\n              var input = embed(12, month-1).concat(embed(7, wday-1), embed(24, hour), [station_id, latitude, longitude, temp], embed(3, weather))\n              var x;\n              // hidden1\n              x = matmul(input, weights1);\n              x = vecadd(x, biases1);\n              x = vec_activate(x, relu);\n              // hidden2\n              x = matmul(x, weights2);\n              x = vecadd(x, biases2);\n              x = vec_activate(x, relu);\n              // hidden3\n              x = matmul(x, weights3);\n              x = vecadd(x, biases3);\n              x = vec_activate(x, relu);\n              // hidden4\n              x = matmul(x, weights4);\n              x = vecadd(x, biases4);\n              x = vec_activate(x, relu);\n              // output\n              x = matmul(x, weights5);\n              x = vecadd(x, biases5);\n              x = vec_activate(x, relu);\n              return x[0];\n              \"\"\" OPTIONS ( library=\"gs://queryit_smart/citibike/udf/weights1.js\",\n    library=\"gs://queryit_smart/citibike/udf/biases1.js\",\n    library=\"gs://queryit_smart/citibike/udf/weights2.js\",\n    library=\"gs://queryit_smart/citibike/udf/biases2.js\",\n    library=\"gs://queryit_smart/citibike/udf/weights3.js\",\n    library=\"gs://queryit_smart/citibike/udf/biases3.js\",\n    library=\"gs://queryit_smart/citibike/udf/weights4.js\",\n    library=\"gs://queryit_smart/citibike/udf/biases4.js\",\n    library=\"gs://queryit_smart/citibike/udf/weights5.js\",\n    library=\"gs://queryit_smart/citibike/udf/biases5.js\",\n    library=\"gs://queryit_smart/citibike/udf/tensor.js\" );\nSELECT\n  station_id,\n  latitude,\n  longitude,\n  hour,\n  usage(<%= month %>,\n    <%= wday %>,\n    hour,\n    station_id,\n    latitude,\n    longitude,\n    <%= temp %>,\n    \"<%= weather %>\") AS usage,\n  LENGTH(stub) as stub_len\nFROM\n  `queryit-smart.citibike.stations_hours_with_stub`"
}
